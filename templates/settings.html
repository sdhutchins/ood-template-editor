{% extends "base.html" %}

{% block title %}Settings - Template Bash Script Editor{% endblock %}

{% block content %}
<br/>
<h3 class="pb-2 mb-4 border-bottom">Settings</h3>
<p class="mb-4 text-muted">Configure additional root directory for saving scripts.</p>

<form id="settingsForm" class="mt-3">
  <div class="card mb-4 shadow-sm" style="border-radius: 10px;">
    <div class="card-body">
      <label for="additional_root" class="form-label fw-semibold">Additional Root Directory</label>
      <input type="text" class="form-control mb-2" id="additional_root" name="additional_root"
             placeholder="/absolute/path/to/directory">
      <div class="form-text">Absolute path to an additional directory that will appear in the "Save to..." dialog. Leave empty to only use your home directory.</div>
      <div id="pathValidation" class="mt-2" style="display: none;"></div>
    </div>
  </div>

  <div id="settingsError" class="alert alert-danger" style="display: none;"></div>
  <div id="settingsSuccess" class="alert alert-success" style="display: none;"></div>

  <button type="submit" class="btn btn-primary px-4 py-2" style="border-radius: 6px;">Save</button>
  <a href="{{ url_for('index') }}" class="btn btn-secondary px-4 py-2 ms-2" style="border-radius: 6px;">Cancel</a>
</form>
{% endblock %}

{% block extra_scripts %}
<script>
  const API_SETTINGS_URL = "{{ url_for('api_get_settings') }}";
  const API_SAVE_SETTINGS_URL = "{{ url_for('api_save_settings') }}";

  async function fetchJson(url, options) {
    const response = await fetch(url, options || {});
    if (!response.ok) {
      let msg = "Request failed";
      try {
        const data = await response.json();
        if (data && data.description) {
          msg = data.description;
        } else if (data && data.error) {
          msg = data.error;
        }
      } catch (e) {
        // ignore parse error, fall back to default message
      }
      throw new Error(msg);
    }
    return response.json();
  }

  async function loadSettings() {
    try {
      const data = await fetchJson(API_SETTINGS_URL);
      document.getElementById("additional_root").value = data.additional_root || "";
    } catch (err) {
      showError("Failed to load settings: " + err.message);
    }
  }

  function showError(message) {
    const errorEl = document.getElementById("settingsError");
    errorEl.textContent = message;
    errorEl.style.display = "block";
    document.getElementById("settingsSuccess").style.display = "none";
  }

  function showSuccess(message) {
    const successEl = document.getElementById("settingsSuccess");
    successEl.textContent = message;
    successEl.style.display = "block";
    document.getElementById("settingsError").style.display = "none";
  }

  function validatePath(path) {
    const validationEl = document.getElementById("pathValidation");
    if (!path || path.trim() === "") {
      validationEl.style.display = "none";
      return true;
    }
    
    // Basic validation - check if it looks like an absolute path
    if (!path.startsWith("/")) {
      validationEl.innerHTML = '<small class="text-warning">⚠ Path should be absolute (start with /)</small>';
      validationEl.style.display = "block";
      return false;
    }
    
    validationEl.innerHTML = '<small class="text-muted">✓ Path format looks valid</small>';
    validationEl.style.display = "block";
    return true;
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadSettings();

    const pathInput = document.getElementById("additional_root");
    pathInput.addEventListener("input", () => {
      validatePath(pathInput.value);
    });

    document.getElementById("settingsForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const additionalRoot = pathInput.value.trim();
      
      if (!validatePath(additionalRoot)) {
        return;
      }

      try {
        const data = await fetchJson(API_SAVE_SETTINGS_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ additional_root: additionalRoot }),
        });
        showSuccess("Settings saved successfully!");
        // Redirect to editor after a short delay
        setTimeout(() => {
          window.location.href = "{{ url_for('index') }}";
        }, 1000);
      } catch (err) {
        showError("Failed to save settings: " + err.message);
      }
    });
  });
</script>
{% endblock %}
