<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Template Bash Script Editor</title>
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
        crossorigin="anonymous"
    >
    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"
    ></script>
    <style>
        body {
            height: 100vh;
            overflow: hidden;
        }
        .editor-textarea {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.9rem;
            white-space: pre;
        }
        .fill-height {
            height: calc(100vh - 64px);
        }
    </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light border-bottom" style="background-color: #e3f2fd" data-bs-theme="light">
    <div class="container-fluid">
      <a class="navbar-brand fw-semibold" href="#">Template Bash Script Editor</a>
    </div>
  </nav>

  <div class="container-fluid mt-2">
    <div class="row fill-height">
      <!-- Left: template selection and editor -->
      <div class="col-md-6 d-flex flex-column">
        <div class="d-flex align-items-center mb-2">
          <label for="templateSelect" class="me-2 fw-semibold">Template</label>
          <select id="templateSelect" class="form-select form-select-sm w-auto"></select>
          <button id="reloadTemplateBtn" class="btn btn-outline-secondary btn-sm ms-2">
            Reload
          </button>
        </div>

        <div class="flex-grow-1 d-flex flex-column">
          <label for="templateEditor" class="form-label fw-semibold">Template editor</label>
          <textarea
            id="templateEditor"
            class="form-control editor-textarea flex-grow-1"
            spellcheck="false"
          ></textarea>
        </div>
      </div>

      <!-- Right: variable form + preview + save -->
      <div class="col-md-6 d-flex flex-column">
        <div class="d-flex align-items-center mb-2">
          <span class="fw-semibold me-2">Template variables</span>
          <button id="refreshVarsBtn" class="btn btn-outline-secondary btn-sm">
            Refresh from template text
          </button>
        </div>

        <div class="border rounded p-2 mb-2 flex-grow-1 overflow-auto" id="variablesContainer">
          <form id="variablesForm" class="row g-2"></form>
          <div id="noVarsHint" class="text-muted small mt-2">
            No variables detected yet. Use <code>{% raw %}{{ variable_name }}{% endraw %}</code> in your template,
            then click “Refresh from template text”.
          </div>
        </div>

        <div class="mb-2">
          <button id="previewBtn" class="btn btn-primary me-2">
            Preview filled script
          </button>
          <button id="saveBtn" class="btn btn-success">
            Save to file…
          </button>
        </div>

        <div class="flex-grow-1 d-flex flex-column">
          <label for="previewEditor" class="form-label fw-semibold">Preview</label>
          <textarea
            id="previewEditor"
            class="form-control editor-textarea flex-grow-1"
            readonly
          ></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Save dialog modal -->
  <div class="modal fade" id="saveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Save script</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="rootSelect" class="form-label fw-semibold">Root</label>
            <select id="rootSelect" class="form-select form-select-sm"></select>
          </div>

          <div class="mb-2 small text-muted">
            Current directory:
            <span id="currentPath" class="fw-semibold"></span>
          </div>

          <div class="border rounded mb-3" style="height: 280px; overflow-y: auto;">
            <ul class="list-group list-group-flush" id="dirListing"></ul>
          </div>

          <div class="mb-3">
            <label for="filenameInput" class="form-label fw-semibold">File name</label>
            <input
              id="filenameInput"
              type="text"
              class="form-control"
              placeholder="myscript.sh"
            >
          </div>

          <div id="saveError" class="text-danger small" style="display:none;"></div>
          <div id="saveSuccess" class="text-success small" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmSaveBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentTemplateName = null;
    let currentDirPath = null;
    let roots = [];
    let saveModalInstance = null;

    function showError(message) {
      alert(message);
    }

    async function fetchJson(url, options) {
      const response = await fetch(url, options || {});
      if (!response.ok) {
        let msg = "Request failed";
        try {
          const data = await response.json();
          if (data && data.description) {
            msg = data.description;
          } else if (data && data.error) {
            msg = data.error;
          }
        } catch (e) {
          // ignore parse error, fall back to default message
        }
        throw new Error(msg);
      }
      return response.json();
    }

    async function loadTemplates() {
      try {
        const data = await fetchJson("/api/templates");
        const select = document.getElementById("templateSelect");
        select.innerHTML = "";

        if (!data.templates || data.templates.length === 0) {
          const opt = document.createElement("option");
          opt.textContent = "No templates found";
          opt.disabled = true;
          opt.selected = true;
          select.appendChild(opt);
          return;
        }

        for (const t of data.templates) {
          const opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = t.label;
          select.appendChild(opt);
        }

        // Automatically load the first template
        currentTemplateName = select.value;
        await loadTemplate(currentTemplateName);
      } catch (err) {
        showError(err.message);
      }
    }

    async function loadTemplate(name) {
      if (!name) return;
      try {
        const data = await fetchJson(`/api/template/${encodeURIComponent(name)}`);
        currentTemplateName = data.name;

        const editor = document.getElementById("templateEditor");
        editor.value = data.content || "";

        buildVarsForm(data.variables || []);
        document.getElementById("previewEditor").value = "";
      } catch (err) {
        showError(err.message);
      }
    }

    function buildVarsForm(variables) {
      const form = document.getElementById("variablesForm");
      const hint = document.getElementById("noVarsHint");
      form.innerHTML = "";

      if (!variables || variables.length === 0) {
        hint.style.display = "block";
        return;
      }

      hint.style.display = "none";

      for (const v of variables) {
        const col = document.createElement("div");
        col.className = "col-12";

        const group = document.createElement("div");
        group.className = "mb-1";

        const label = document.createElement("label");
        label.className = "form-label form-label-sm fw-semibold mb-1";
        label.textContent = v;
        label.setAttribute("for", `var-${v}`);

        const input = document.createElement("input");
        input.type = "text";
        input.className = "form-control form-control-sm";
        input.id = `var-${v}`;
        input.name = v;

        group.appendChild(label);
        group.appendChild(input);
        col.appendChild(group);
        form.appendChild(col);
      }
    }

    function extractVarsFromTemplateText() {
      const text = document.getElementById("templateEditor").value || "";
      {% raw %}
      const pattern = /{{\s*([a-zA-Z_][a-zA-Z0-9_]*)\s*}}/g;
      {% endraw %}
      const varsSet = new Set();
      let match;
      while ((match = pattern.exec(text)) !== null) {
        varsSet.add(match[1]);
      }
      buildVarsForm(Array.from(varsSet).sort());
    }

    function collectVariablesFromForm() {
      const form = document.getElementById("variablesForm");
      const inputs = form.querySelectorAll("input[name]");
      const vars = {};
      inputs.forEach((input) => {
        vars[input.name] = input.value;
      });
      return vars;
    }

    async function previewScript() {
      const templateText = document.getElementById("templateEditor").value || "";
      const variables = collectVariablesFromForm();

      try {
        const data = await fetchJson("/api/render", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ template: templateText, variables }),
        });
        document.getElementById("previewEditor").value = data.rendered || "";
      } catch (err) {
        showError(err.message);
      }
    }

    async function loadRoots() {
      try {
        const data = await fetchJson("/api/roots");
        roots = data.roots || [];

        const select = document.getElementById("rootSelect");
        select.innerHTML = "";

        for (const r of roots) {
          const opt = document.createElement("option");
          opt.value = r.id;
          opt.textContent = r.label;
          opt.dataset.path = r.path;
          select.appendChild(opt);
        }

        if (roots.length > 0) {
          await listDirectory(roots[0].path);
        }

        select.addEventListener("change", async () => {
          const selected = select.options[select.selectedIndex];
          const path = selected ? selected.dataset.path : null;
          if (path) {
            await listDirectory(path);
          }
        });
      } catch (err) {
        showError(err.message);
      }
    }

    async function listDirectory(path) {
      try {
        const data = await fetchJson(`/api/list_dir?path=${encodeURIComponent(path)}`);
        currentDirPath = data.path;

        document.getElementById("currentPath").textContent = data.path;

        const list = document.getElementById("dirListing");
        list.innerHTML = "";

        // Parent entry
        if (data.parent) {
          const liUp = document.createElement("li");
          liUp.className = "list-group-item list-group-item-action";
          liUp.textContent = "..";
          liUp.style.cursor = "pointer";
          liUp.onclick = () => listDirectory(data.parent);
          list.appendChild(liUp);
        }

        for (const e of data.entries) {
          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between align-items-center";

          const label = document.createElement("span");
          label.textContent = e.name;

          if (e.type === "dir") {
            li.style.cursor = "pointer";
            li.onclick = () => listDirectory(e.path);

            const badge = document.createElement("span");
            badge.className = "badge bg-secondary rounded-pill";
            badge.textContent = "dir";
            li.appendChild(label);
            li.appendChild(badge);
          } else {
            li.appendChild(label);
          }

          list.appendChild(li);
        }
      } catch (err) {
        showError(err.message);
      }
    }

    function openSaveModal() {
      document.getElementById("saveError").style.display = "none";
      document.getElementById("saveSuccess").style.display = "none";
      const filenameInput = document.getElementById("filenameInput");

      // Suggest a name based on template or default
      if (currentTemplateName) {
        let base = currentTemplateName.replace(/\.sh(\.j2)?$/, "");
        filenameInput.value = base + ".sh";
      } else {
        filenameInput.value = "script.sh";
      }

      if (!saveModalInstance) {
        const modalEl = document.getElementById("saveModal");
        saveModalInstance = new bootstrap.Modal(modalEl);
      }
      saveModalInstance.show();
    }

    async function confirmSave() {
      const errorEl = document.getElementById("saveError");
      const successEl = document.getElementById("saveSuccess");
      errorEl.style.display = "none";
      successEl.style.display = "none";

      const filename = document.getElementById("filenameInput").value.trim();
      if (!filename) {
        errorEl.textContent = "Please enter a file name.";
        errorEl.style.display = "block";
        return;
      }

      const content = document.getElementById("previewEditor").value ||
                      document.getElementById("templateEditor").value ||
                      "";

      if (!currentDirPath) {
        errorEl.textContent = "No directory selected.";
        errorEl.style.display = "block";
        return;
      }

      try {
        const data = await fetchJson("/api/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            directory: currentDirPath,
            filename: filename,
            content: content,
          }),
        });
        successEl.textContent = "Saved to " + data.path;
        successEl.style.display = "block";
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.style.display = "block";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("templateSelect").addEventListener("change", (e) => {
        loadTemplate(e.target.value);
      });

      document.getElementById("reloadTemplateBtn").addEventListener("click", () => {
        if (currentTemplateName) {
          loadTemplate(currentTemplateName);
        }
      });

      document.getElementById("refreshVarsBtn").addEventListener("click", (e) => {
        e.preventDefault();
        extractVarsFromTemplateText();
      });

      document.getElementById("previewBtn").addEventListener("click", (e) => {
        e.preventDefault();
        previewScript();
      });

      document.getElementById("saveBtn").addEventListener("click", (e) => {
        e.preventDefault();
        openSaveModal();
      });

      document.getElementById("confirmSaveBtn").addEventListener("click", (e) => {
        e.preventDefault();
        confirmSave();
      });

      loadTemplates();
      loadRoots();
    });
  </script>
</body>
</html>